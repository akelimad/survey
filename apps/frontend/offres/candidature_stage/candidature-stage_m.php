<div class='texte'>   <h1>CANDIDATURE POUR STAGE</h1><div class="ligneBleu"></div><br/><?php////////////////////////////////////////////////////////////////////////////////////////////////////  if(isset($_SESSION['abb_id_candidat'])) {$id_candidat =$_SESSION['abb_id_candidat'];$id_conf=0; $select_formations_tst = mysql_query("SELECT * from formations where candidats_id = '".safe($id_candidat)."' LIMIT 0 , 1"); $formations_tst = mysql_fetch_array($select_formations_tst);  } else {$id_conf=1;}////////////////////////////////////////////////////////////////////////////////////////////////////?><?php if (!isset($_SESSION["abb_login_candidat"]) || $_SESSION["abb_login_candidat"] == ""):$_SESSION["c_st"] = "http://" . $_SERVER["SERVER_NAME"] . $_SERVER["REQUEST_URI"];  	echo "<div  class='alert alert-error'><ul><li style='color:#FF0000'>Vous n'êtes pas encore connecté à votre espace candidat</li></ul></div>";   echo '<meta http-equiv="refresh" content="0; url='.$urlcandidat.'/">';elseif (!($formations_tst) && $id_conf!=1 ):?><!-- START  div class='texte'  --><div class="alert alert-error"><ul><li style='color:#FF0000'>Il faut avoir renseigné au moins une formation pour pouvoir déposer une candidature .</li><li style='color:#FF0000'>Vous allez être redirigé dans quelques secondes à votre formation            <a href="<?php echo $urlcandidat; ?>/cv/formations/" >Ne pas attendre</a></li></ul><meta http-equiv="refresh" content="5;URL=<?php echo $urlcandidat; ?>/cv/formations/"></div><!-- END  div class='texte'  --><?php else:?><?php $select_model1=mysql_query("select count(*) from candidature_stage where candidats_id='".safe($_SESSION['abb_id_candidat'])."'  ");$select_model1 = mysql_fetch_array($select_model1);if($select_model1[0]<1){$select_model=mysql_query("select count(*) from cv  where candidats_id='".safe($_SESSION['abb_id_candidat'])."'  AND actif=1");$select_model = mysql_fetch_array($select_model);if($select_model[0]>0 ){       ?>      <?php         //config de la base de donnees        $config = array(                    'dsn' =>'mysql:host='.$serveur.';dbname='.$bdd,                    'dbuser' => $user,                    'dbpass' => $passwd          );        $messages=array();        $messages_succ=array();        //Envoi et validation du formulaire        if($_SERVER['REQUEST_METHOD'] == 'POST')        {          if(isset($_POST['go']))          {            $nomecole    =     isset($_POST['nomecole'])     ? trim($_POST['nomecole'])         : "";            $typestage   =     isset($_POST['typestage'])    ? trim($_POST['typestage'])        : "";            $entite      =     isset($_POST['entite'])       ? trim($_POST['entite'])           : "";            $duree_stage =     isset($_POST['duree_stage'])    ? trim($_POST['duree_stage'])        : "";            $objet_stage =     isset($_POST['objet_stage'])    ? trim($_POST['objet_stage'])        : "";            $motivations =     isset($_POST['motivations'])    ? trim($_POST['motivations'])        : "";                        $mssg= '';            if(empty($nomecole)){               $mssg .= "<li style='color:#FF0000'>Vous n'avez pas pr&eacute;cis&eacute; le nom de l'&eacute;cole</li>";}            if(empty($typestage)){               $mssg.= "<li style='color:#FF0000'>Vous n'avez pas pr&eacute;cis&eacute; le type du stage</li>";}            if(empty($entite)){               $mssg.= "<li style='color:#FF0000'>Vous n'avez pas pr&eacute;cis&eacute; le nom de l'entit&eacute; demand&eacute;e</li>";}            if(empty($duree_stage)){               $mssg.= "<li style='color:#FF0000'>Vous n'avez pas pr&eacute;cis&eacute; la dure&eacute; du stage</li>";}            if(empty($objet_stage)){               $mssg.= "<li style='color:#FF0000'>Vous n'avez pas pr&eacute;cis&eacute; l'objet du stage</li>";}            if(empty($motivations)){              $mssg.= "<li style='color:#FF0000'>Vous n'avez pas pr&eacute;cis&eacute; vos motivations</li>";}          			                array_push($messages,$mssg);                    //Insertion des donnees dans la BD                    $messages = array_filter($messages);					if(empty($messages) )                    {                        try                         {                          $conn = new PDO($config['dsn'], $config['dbuser'], $config['dbpass']);                          $conn->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);                        }                         catch (PDOException $e)                         {                          echo $e->getMessage();                        }                        $etat = 'en attente';                        if($conn)                        {$stmt = $conn->prepare("INSERT INTO candidature_stage (candidats_id, ecole, type, entite, duree, motivations, objet, etat,date)VALUES(:id_candidat, :ecole, :type, :entite, :duree, :motivations, :objet, :etat, :date)");$date = date("d/m/Y");$stmt->bindParam(':id_candidat',$_SESSION['abb_id_candidat'], PDO::PARAM_INT);$stmt->bindParam(':ecole', $nomecole, PDO::PARAM_STR);$stmt->bindParam(':type', $typestage, PDO::PARAM_STR);$stmt->bindParam(':entite',$entite, PDO::PARAM_STR);$stmt->bindParam(':duree', $duree_stage, PDO::PARAM_STR);$stmt->bindParam(':motivations', $motivations, PDO::PARAM_STR);$stmt->bindParam(':objet', $objet_stage, PDO::PARAM_STR);$stmt->bindParam(':etat', $etat, PDO::PARAM_STR);$stmt->bindParam(':date', $date, PDO::PARAM_STR);$stmt->execute();array_push($messages_succ,"<li style='color:#468847'>Votre candidature a &eacute;t&eacute; bien pris en compte</li>");$cand_stage_succeded=true;$id_candidat = $_SESSION['abb_id_candidat'];$req = mysql_query("SELECT * from candidats where candidats_id='".safe($id_candidat)."' ");$rep = mysql_fetch_array($req);// envoyer email candidatrequire_once("./candidature-stage_m_email_1.php");// envoyer email admin//require_once("./candidature-stage_m_email_2.php");}}}}?><?php		      ?><ul><?php foreach ($messages as $messages): ?>    <div class="alert alert-error">    <?php echo $messages; ?>    </div><?php endforeach; ?></ul><ul><?php foreach ($messages_succ as $messages_succ): ?>    <div class="alert alert-success">    <?php echo $messages_succ; ?>    <meta http-equiv="refresh" content="3;URL=<?php echo $urlcandidat; ?>/compte/">    </div><?php endforeach; ?></ul> <?php include("candidature-stage_m_form.php");?> <?php  ////////////////}                elsearray_push($messages,"<li style='color:#FF0000'>  Pour d&eacute;poser votre candidature pour un stage,veuillez <a href='$urlcandidat;/cv/'>compléter votre profil</a></li>");                  echo " ";              }              else              {                echo '<meta http-equiv="refresh" content="10;URL='.$urlcandidat.'/compte/">';                echo '<div  class="alert alert-error"><ul><li style="color:#FF0000">Vous avez d&eacute;j&agrave; d&eacute;pos&eacute; une candidature pour stage. Vous ne pouvez postuler qu\'une seule fois. Vous allez &ecirc;tre redirig&eacute; dans quelques secondes &agrave;                 votre compte<a href="'.$urlcandidat.'/compte/" > Ne pas attendre</a>                </li></ul></div>';              }                 ?>                <?php endif;?>              </div>